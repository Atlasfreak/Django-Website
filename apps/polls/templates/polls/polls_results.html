{% extends 'polls/polls_base.html' %}
{% load static %}

{% block title %}{{poll.title}} - Ergebnisse{% endblock %}
{% block brand %}{{poll.title}} - Ergebnisse{% endblock %}
{% block content %}
    <div class="rounded-lg p-3 bg-white shadow my-4">
        <p><a href={% url 'polls:csv' token=poll.token %} target="_blank">CSV herunterladen</a></p>
        <div class="d-flex">
            <div class="h1">{{poll.title}}</div>
            <div class="ml-auto align-self-center h4">Ersteller: {% if poll.creator.full_name %}{{poll.creator.full_name}}{% else %}{{poll.creator.username}}{% endif %}</div>
        </div>
        <hr>
        <section class = "mt-3">
            <p class="text-break">{{poll.info_text|urlize|linebreaks}}</p>
        </section>
        <hr>
        <div class="questions">
            {% for chart in chart_list %}
                <div class="chart-{{chart.id}}-container mb-4" style="position: relative">
                    <canvas id="chart-{{chart.id}}"></canvas>
                </div>
            {% endfor %}
        </div>
        <button class="text-toggle btn btn-outline-info" type="button" data-toggle="collapse" data-target="#results-table" aria-expanded="false" aria-controls="results-table">
            <span class = "text-collapsed"><i class="fas fa-angle-down fa-lg"></i> Ergebnisse anzeigen</span>
            <span class = "text-expanded"><i class="fas fa-angle-up fa-lg"></i> Ergebnisse verstecken</span>
        </button>
        <div class="collapse mt-3" id="results-table">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Einsendedatum</th>
                            {% for question in poll.questions.all %}
                                <th scope="col">{{question.text}}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for submission in poll.submissions.all %}
                            <tr>
                                <th scope="row">{{submission.submission_date}}</th>
                                {% for question in poll.questions.all %}
                                    <td>
                                        {% for answer in question.answers.all %}
                                            {% if answer.submission == submission %}
                                                {% if question.type.enable_choices %}
                                                    {% for choice in answer.choices.all %}
                                                        {{choice.text}}
                                                    {% endfor %}
                                                {% else %}
                                                    {{answer.value}}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock content %}
{% block javascript %}
    {{chart_list|json_script:"chart_list"}}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.js" integrity="sha512-zO8oeHCxetPn1Hd9PdDleg5Tw1bAaP0YmNvPY8CwcRyUk7d7/+nyElmFrB6f7vg4f7Fv4sui1mcep8RIEShczg==" crossorigin="anonymous"></script>
    
    <!-- Import D3 Scale Chromatic via CDN -->
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <script src="{% static 'js/polls/utils/colorGenerator.js' %}"></script>
    <script src="{% static 'js/polls/results.js' %}"></script>
    <script>
        function beforePrintHandler () {
            for (var id in Chart.instances) {
                Chart.instances[id].resize();
            }
        }
        window.addEventListener("beforeprint", beforePrintHandler());
    </script>
{% endblock javascript %}