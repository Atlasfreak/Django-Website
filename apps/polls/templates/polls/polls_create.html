{% extends 'polls/polls_base.html' %}
{% load widget_tweaks %}
{% load polls_tags %}
{% load static %}

{% block sytlesheet %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock sytlesheet %}

{% block title %}{{ block.super }} Erstellen{% endblock %}
{% block brand %}Umfrage erstellen{% endblock %}
{% block content %}
    <div class = "content-sectiion">
        {% if poll_form.non_field_errors %}
            {% for err in poll_form.non_field_errors %}
                <div class = "my-1 alert alert-danger alert-dismissible fade show" role="alert">
                    {{ err }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
        <form method="POST" autocomplete="off">
            {% csrf_token %}
            <div class="card shadow my-4">
                <fieldset>

                    <legend class = "card-header">
                        Umfrage Erstellen
                    </legend>

                    <div class="card-body">

                        {% with field=poll_form.title %}
                            {% include "base_inputs/input_form_group.html" with field=field field_with_filters=field %}
                        {% endwith %}

                        {% with field=poll_form.start_date %}
                            <div id="date-time-div">
                                {% include "base_inputs/input_group.html" with field=field prepend_text='<i class="far fa-calendar-alt fa-lg"></i>' field_with_filters=field|set_data:"input" %}
                            </div>
                        {% endwith %}

                        {% with field=poll_form.end_date %}
                            <div id="date-time-div">
                                {% include "base_inputs/input_group.html" with field=field prepend_text='<i class="far fa-calendar-alt fa-lg"></i>' field_with_filters=field|set_data:"input" %}
                            </div>
                        {% endwith %}

                        {% with field=poll_form.info_text %}
                            {% include "base_inputs/input_form_group.html" with field=field field_with_filters=field %}
                        {% endwith %}

                        <div class="custom-control custom-switch form-group">
                            {% render_field poll_form.multiple_votes class+="custom-control-input" %}
                            <label for="{{ poll_form.multiple_votes.id_for_label }}" class="custom-control-label">{{ poll_form.multiple_votes.label }}</label>
                        </div>

                        <div class="custom-control custom-switch form-group">
                            {% render_field poll_form.is_public class+="custom-control-input" %}
                            <label for="{{ poll_form.is_public.id_for_label }}" class="custom-control-label">{{ poll_form.is_public.label }}</label>
                        </div>


                    </div>

                </fieldset>
            </div>

            <fieldset>

                {{ question_formset.management_form }}
                <div id="questions">
                    {% for question_form in question_formset %}
                        {% include 'polls/include/question.html' with question_form=question_form question_formset=question_formset choice_formset=choice_formset_list|index:forloop.counter0 %}
                    {% endfor %}

                    <button class="btn btn-success add_form" type="button" id="{{question_formset.prefix}}"><i class="fas fa-plus"></i> Frage hinzufügen</button>

                    <div hidden="" id="{{question_formset.prefix}}-empty">
                        {% include 'polls/include/question.html' with question_form=question_formset.empty_form choice_formset=empty_choice_formset %}
                    </div>
                </div>
            </fieldset>
            <hr>
            <div class="form-group">
                <button class = "btn btn-outline-success" type = "submit">
                    Erstellen
                </button>
            </div>
        </form>
    </div>
{% endblock content %}

{% block javascript %}
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/minMaxTimePlugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/rangePlugin.js"></script>
    <script>
    $(document).ready(function() {
        flatpickr('#date-time-div', {
            enableTime: true,
            altInput: true,
            time_24hr: true,
            wrap: true,
            locale: "de",
            minDate: "today",
            defaultDate: "{% now 'Y-m-d H:i' %}",
            dateFormat: "Y-m-d H:i",
            altFormat: "D j. F Y H:i",
            plugins: [
                new minMaxTimePlugin({
                    table: {
                        "{% now 'Y-m-d' %}": {
                            minTime: "{% now 'H:i' %}",
                        }
                    }
                })
            ]
        });
    });
    </script>
    <script src="{% static 'polls/js/create.js' %}" type="text/javascript"></script>
    <script>
    $('.custom-select').each(function(){
        changeAvailableOptions(this, '.card', '#options', {{options_deactivated}}, 'Dieser Fragetyp lässt keine Auswahlmöglichkeiten zu.');
    });

    $('form').on('click', '.add_form', function(){
        addForm(this);
    });

    $('form').on('click', '.remove_form', function(){
        removeForm(this);
    });

    $('form').on('change', '.custom-select', function(){
        changeAvailableOptions(this, '.card', '#options', {{options_deactivated}}, 'Dieser Fragetyp lässt keine Auswahlmöglichkeiten zu.')
    });
    </script>
{% endblock javascript %}